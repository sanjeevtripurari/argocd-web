apiVersion: batch/v1
kind: Job
metadata:
  name: config-applier
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-content
          image: busybox
          command: ['sh', '-c']
          args:
            - |
              echo "Waiting for /webpages/index.html to exist...";
              while [ ! -f /webpages/index.html ]; do
                sleep 1;
              done;
              echo "Found index.html!";
          volumeMounts:
            - name: web-content
              mountPath: /webpages

      containers:
        - name: config-applier
          image: busybox
          command: ["/bin/sh", "-c"]
          args:
            - |
              LANG=$(cat /config/default-lang)
              COLOR=$(cat /config/bg-color)

              # Replace background color
              sed -i "s/background-color: [^;]*/background-color: $COLOR/" /webpages/index.html

              # Replace default quote based on language
              QUOTE=""
              case "$LANG" in
                en) QUOTE='The best way to predict the future is to invent it.' ;;
                fr) QUOTE="La meilleure façon de prédire l'avenir est de l'inventer." ;;
                hi) QUOTE='भविष्य की भविष्यवाणी करने का सबसे अच्छा तरीका है उसे बनाना।' ;;
              esac

              sed -i "s|<h1 id=\"quote\">.*</h1>|<h1 id=\"quote\">$QUOTE</h1>|" /webpages/index.html
          volumeMounts:
            - name: web-content
              mountPath: /webpages
            - name: config
              mountPath: /config
      restartPolicy: Never
      volumes:
        - name: web-content
          hostPath:
            path: /mnt/data/webpages
            type: DirectoryOrCreate
        - name: config
          configMap:
            name: page-config
  backoffLimit: 1
